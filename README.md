В качестве "простого балансировщика нагрузки" был выбран nginx, т.к. что-то более менее знакомое и умеет балансировать с udp (в отличии от HaProxy например).

Envoy для меня не знаком, хоть и не уступает nginx, а возможно даже и лучше, хотя бы в том, что для Active Health Check не требует платной подписки.

Настроена роль balance для развертывания docker контейнера  с необходимыми конфигами, конфиги в папке **roles/templates** вместе с Dockerfile.

Playbook для ansible в папке **playbook** соответственно

# nginx.conf
### stream
В секции **stream** описаны backend'ы с методом балансировки нагрузки, при котором запросы передаются к серверу с наименьшим количеством активных соединений.

Также настроен Passive Health Check, при котором, если в течении **fail_timeout** было неудачных попыток=**max_fails**, то сервер считается недоступным на **fail_timeout**
### server
В секции **server** назначен порт для сокета, на который балансировщик будет принимать запросы.

Директивой **proxy_pass** указан пул backend серверов на который будет передаваться запрос от клиента.

**proxy_timeout** для того чтобы по истечении укзанного времени закрывать не активные соединения

**proxy_responses** после передачи n датаграм сессия закрывается

# Dockerfile
1. Извлекаем image из nginx
2. Удаляем дефолтные виртуальные хосты чтобы не мешались
3. Копируем конфиг nginx
4. Открываем порт 1234/udp

# Ansible
### tasks
1. Установил docker
2. Скопировал конфиги из template
3. Запулил image nginx
4. Выполнил проверку на существование контейнера с похожим именем, если есть, удалить
5. Стартанул контейнер с именем balancing и выкинул порты наружу
6. Добавить конфиг **balance.service** в systemd для автостарта контейнера и удобства управления
7. Выполнил **handlers**
