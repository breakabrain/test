В качестве "простого балансировщика нагрузки" был выбран nginx, т.к. что-то более менее знакомое и умеет балансировать с udp (в отличии от HaProxy например).

Envoy для меня не знаком, хоть и не уступает nginx, а возможно даже и лучше, хотя бы в том, что для Active Health Check не требует платной подписки.

Настроена роль **balance** для развертывания docker контейнера  с необходимыми конфигами, конфиги в папке **roles/balance/files**.

Была добавлена роль **keepalived**, в которой реализуется отказоустойчивость балансировщика с помощью инструмента keepalived.

Количество нод балансировщика (в теории)неограничено.

Playbook для ansible в папке **playbook** соответственно

# nginx.conf
### stream
В секции **stream** описаны backend'ы с методом балансировки нагрузки, при котором запросы передаются к серверу с наименьшим количеством активных соединений.

Также настроен Passive Health Check, при котором, если в течении **fail_timeout** было неудачных попыток=**max_fails**, то сервер считается недоступным на **fail_timeout**
### server
В секции **server** назначен порт для сокета, на который балансировщик будет принимать запросы.

Директивой **proxy_pass** указан пул backend серверов на который будет передаваться запрос от клиента.

**proxy_timeout** для того чтобы по истечении укзанного времени закрывать не активные соединения

**proxy_responses** после передачи n датаграм сессия закрывается

# Keepalived
### env.yaml
Здесь устанавливаем переменные такие как:
```
KEEPALIVED_INTERFACE #интерфейс на физической машине
KEEPALIVED_VIRTUAL_IPS #Floating IP
```
Остальные меняем по желанию

### keealived.conf
Здесь всё стандартно, ходят бродкасты, состояние по умолчанию всегда BACKUP

# Ansible
### tasks
1. Установил docker
2. Скопировал конфиги из files
3. Выполнил проверку на существование контейнера с похожим именем, если есть, удалить
4. Стартанул контейнер с именем balancing из образа nginx с монтированием конфигов и выкинул порты наружу
5. Копируем конфиги keealived
6. Проверяем на уществование контейнера с похожим именем, если есть, удалить
7. Включаем модуль ip_vs, иначе не заработает балансировщик
7. Стартуем keepalived из образа osixia/keepalived с монтированием конфигов и привязкой к сети хост-машины
